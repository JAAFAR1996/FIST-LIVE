name: ğŸš€ Enhanced CI/CD Pipeline - FIST-LIVE (Antigravity Ready)

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "**.md"
      - ".gitignore"
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  NODE_VERSION: 20.11.0
  PNPM_VERSION: 9.1.0
  CI: true

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ==================== SETUP ====================
  setup:
    name: ğŸ“‹ Environment Setup
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.versions.outputs.node }}
      pnpm-version: ${{ steps.versions.outputs.pnpm }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Get versions
        id: versions
        run: |
          echo "node=${{ env.NODE_VERSION }}" >> $GITHUB_OUTPUT
          echo "pnpm=${{ env.PNPM_VERSION }}" >> $GITHUB_OUTPUT

  # ==================== LINT & TYPE CHECK ====================
  lint:
    name: ğŸ¨ Lint & Type Check
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ needs.setup.outputs.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: ğŸ“¦ Setup pnpm ${{ needs.setup.outputs.pnpm-version }}
        uses: pnpm/action-setup@v2
        with:
          version: ${{ needs.setup.outputs.pnpm-version }}

      - name: ğŸ’¾ Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "pnpm"

      - name: ğŸ“š Install dependencies
        run: pnpm install --prefer-offline
        timeout-minutes: 10

      - name: ğŸ” TypeScript type check
        run: pnpm run check
        timeout-minutes: 10

  # ==================== UNIT TESTS ====================
  test:
    name: ğŸ§ª Unit Tests
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ needs.setup.outputs.pnpm-version }}

      - name: ğŸ’¾ Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "pnpm"

      - name: ğŸ“š Install dependencies
        run: pnpm install --prefer-offline
        timeout-minutes: 10

      - name: ğŸ§ª Run unit tests
        run: pnpm run test --run
        env:
          NODE_ENV: test
        timeout-minutes: 15

      - name: ğŸ“Š Generate coverage report
        run: pnpm run test:coverage || true
        timeout-minutes: 10

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: ${{ github.event_name != 'pull_request' && hashFiles('./coverage/coverage-final.json') != '' }}
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          fail_ci_if_error: false

  # ==================== BUILD ====================
  build:
    name: ğŸ—ï¸ Build
    needs: [setup, lint]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ needs.setup.outputs.pnpm-version }}

      - name: ğŸ’¾ Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "pnpm"

      - name: ğŸ“š Install dependencies
        run: pnpm install --prefer-offline
        timeout-minutes: 10

      - name: ğŸ¨ Build client
        run: pnpm run build:client
        env:
          NODE_ENV: production
          VITE_APP_TITLE: FIST-LIVE
        timeout-minutes: 15

      - name: ğŸ”¨ Build project (full)
        run: pnpm run build
        env:
          NODE_ENV: production
        timeout-minutes: 15

      - name: ğŸ“Š Verify build output
        run: |
          if [ ! -d "dist/client" ] && [ ! -d "dist" ] && [ ! -d "build" ]; then
            echo "âŒ Build output not found!"
            ls -la
            exit 1
          fi
          echo "âœ… Build output verified"
          ls -la dist/ || true

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist-${{ github.run_number }}
          path: |
            dist/
          retention-days: 7
          if-no-files-found: warn

  # ==================== SECURITY ====================
  security:
    name: ğŸ” Security Checks
    needs: [setup, lint]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ needs.setup.outputs.pnpm-version }}

      - name: ğŸ’¾ Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ needs.setup.outputs.node-version }}
          cache: "pnpm"

      - name: ğŸ“š Install dependencies
        run: pnpm install --prefer-offline
        timeout-minutes: 10

      - name: ğŸ” Audit npm packages
        run: pnpm audit --audit-level=moderate || true

      - name: ğŸ” Secret scanning
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ==================== QUALITY GATE ====================
  quality-gate:
    name: âœ¨ Quality Gate
    needs: [lint, test, build, security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“Š Check pipeline status
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   CI Pipeline Status Report        â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Lint:      ${{ needs.lint.result }}"
          echo "â•‘ Test:      ${{ needs.test.result }}"
          echo "â•‘ Build:     ${{ needs.build.result }}"
          echo "â•‘ Security:  ${{ needs.security.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [[ "${{ needs.lint.result }}" == "failure" || \
                "${{ needs.test.result }}" == "failure" || \
                "${{ needs.build.result }}" == "failure" ]]; then
            echo ""
            echo "âŒ CRITICAL: Pipeline Failed"
            exit 1
          else
            echo ""
            echo "âœ… SUCCESS: All checks passed!"
          fi

      - name: ğŸ“¢ Notify success
        if: success()
        run: echo "ğŸ‰ Pipeline completed successfully!"
